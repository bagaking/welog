# 系统架构设计

## 核心概念

### Context
- 作为核心容器，管理 Span 树和生命周期
- 不可变设计，每次修改返回新实例
- 支持 fork 子 Context，用于并发场景
- 维护 traceId 在整个调用链中的一致性
- 通过 rootSpanDepth 控制 Span 深度

### Span
- 轻量级操作单元，记录具体操作
- 与 Context 紧密集成
- 维护父子关系，形成调用树
- 通过 depth 属性反映调用深度
- 支持属性、错误和日志记录

### Logger
- 提供灵活的日志记录功能
- 中间件机制支持可扩展性
- 与 Context 和 Span 自然集成
- 支持采样和字段选择
- 多级别日志支持

## 设计演进

### 初始设计
- Context 作为独立模块
- Span 作为独立模块
- Logger 作为独立模块

### 重构优化
1. 将 Span 移入 Context 模块，因为两者紧密关联
2. 统一类型定义到 types/index.d.ts
3. 简化 API 设计，如 newContext 替代 createRootContext

### Depth 处理演进
1. 最初作为 Context 的属性
2. 改为 Span 的属性，更符合语义
3. 最终设计：
   - Span.depth 表示在调用链中的深度
   - Context.rootSpanDepth 用于新 span 的深度计算
   - fork 时自动递增深度

## 实现特点

### 不可变性
- Context 的所有修改都返回新实例
- Span 数据的修改通过方法调用
- 确保并发安全

### 树形结构
- Context 树：通过 parent-child 关系
- Span 树：通过 parent-child 关系
- 支持局部树和全局树的获取

### 日志集成
- 自动关联 Context 和 Span
- 支持基于 traceId 的采样
- 灵活的字段选择和格式化

## 技术实现

### Context 实现
- 使用 TypeScript 类实现，提供完整类型支持
- 内部维护 ContextData、children 集合和 Logger 实例
- 提供 fork、span 管理和树构建等核心功能
- 使用哨兵 Span 简化树结构管理

### Span 实现
- 轻量级数据结构，记录操作信息
- 支持属性设置、错误记录和日志记录
- 通过 depth 属性支持层级显示
- 与 Context 紧密集成，自动维护父子关系

### Logger 实现
- 基于中间件链的设计
- 支持多种日志级别（DEBUG、INFO、WARN、ERROR）
- 提供灵活的配置选项
- 自动关联 Context 和 Span 信息

### 中间件实现
1. SpanLogMiddleware
   - 支持日志采样
   - 自动记录日志到关联的 Span
2. ConsoleMiddleware
   - 灵活的字段选择
   - 支持 Context 和 Span 信息展示
   - 基于深度的日志缩进
   - 错误信息处理

## 最佳实践

### Context 使用
1. 在服务入口创建根 Context
2. 调用子函数时使用 fork
3. 保持 traceId 在调用链中的一致性
4. 合理使用 module 和 params 参数

### Span 使用
1. 使用有意义的操作名称
2. 及时结束 Span
3. 记录关键属性和错误信息
4. 注意控制 Span 的粒度

### 日志使用
1. 选择合适的日志级别
2. 配置合适的中间件
3. 使用采样控制日志量
4. 合理设置字段选择器

## 扩展性设计

### 中间件扩展
- 支持自定义中间件
- 灵活的中间件配置
- 链式处理机制
- 采样和过滤支持

### 序列化支持
- Context 和 Span 数据可序列化
- 支持跨进程传递
- 支持持久化存储
- 支持分布式追踪

### 监控集成
- 提供性能指标收集
- 支持调用链分析
- 错误追踪和统计
- 支持第三方监控系统集成

## 性能考虑

### 内存优化
- 轻量级数据结构
- 及时清理完成的 Span
- 合理使用采样
- 避免冗余数据

### 并发处理
- 不可变设计确保线程安全
- 避免锁竞争
- 支持高并发场景
- 最小化同步开销

### 日志性能
- 异步日志处理
- 批量写入优化
- 采样控制
- 缓冲区管理

## 未来规划

### 功能增强
1. 分布式追踪支持
2. 更多内置中间件
3. 性能分析工具
4. 可视化支持

### 性能优化
1. 内存池优化
2. 日志聚合
3. 索引优化
4. 压缩算法

### 生态集成
1. OpenTelemetry 支持
2. 云平台集成
3. 监控系统集成
4. 日志分析工具
